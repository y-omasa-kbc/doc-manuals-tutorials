# **PHPにおけるCookieとセッションを利用したセッション管理**

Webアプリケーション開発を学ぶ上で、**セッション管理**は避けては通れない重要な概念です。ユーザーがログイン状態を維持したり、ショッピングカートに商品を入れたりといった、一連の操作を追跡するために必要不可欠な技術です。

この資料では、PHPにおける代表的なセッション管理の方法である「Cookie」と「セッション」について、その仕組みと使い分けを解説します。

## **1. なぜセッション管理が必要なのか？ - HTTPのステートレス性**

まず、セッション管理の必要性を理解するために、Webの基本プロトコルであるHTTPの特性を知る必要があります。

HTTPは **ステートレス（Stateless）** なプロトコルです。これは、サーバーがクライアント（ブラウザ）からの各リクエストを、それぞれ独立した新しいものとして扱うという意味です。サーバーは過去のリクエストを記憶していません。

**例：**

1. ユーザーがログインページでIDとパスワードを送信し、認証に成功する。  
2. ユーザーがマイページへのリンクをクリックする。  
3. サーバーは、マイページへのリクエストが「先ほどログインしたユーザー」からのものだと認識できない。

このままでは、ページを移動するたびにユーザー情報を忘れてしまい、ログイン状態を維持することすらできません。この問題を解決するのがセッション管理です。

## **2. Cookieによるセッション管理**

Cookieは、サーバーから送信され、**ブラウザ（クライアント側）に保存される小さなテキストファイル**です。ブラウザは、一度Cookieを受け取ると、以降同じサーバーにリクエストを送る際に、そのCookieを自動的に添付して送信します。

### **Cookieの仕組み**

1. **サーバー → ブラウザ**: サーバーがレスポンスヘッダにSet-Cookieを含め、ブラウザに情報を保存するよう指示する。  
2. **ブラウザ**: 受け取ったCookieを指定されたドメインとパスに関連付けて保存する。  
3. **ブラウザ → サーバー**: 次回以降、そのドメインにリクエストを送る際、リクエストヘッダに保存しておいたCookieを自動的に含めて送信する。  
4. **サーバー**: リクエストに含まれるCookie（$_COOKIEスーパーグローバル変数でアクセス）を読み取り、ユーザーを識別する。

### **PHPでの使い方**

#### **Cookieの保存**

setcookie()関数を使用します。**HTMLが出力される前に**呼び出す必要があります。
```php
// 'username'という名前で'Taro'という値を1時間(3600秒)保存する  
setcookie('username', 'Taro', time() + 3600);

// パスを指定する場合  
setcookie('visited', 'true', time() + 86400, '/'); // サイト全体で有効
```
#### **Cookieの取得**

スーパーグローバル変数 $_COOKIE を使って取得します。
```php
if (isset($_COOKIE['username'])) {  
    echo 'ようこそ、' . htmlspecialchars($_COOKIE['username']) . 'さん';  
} else {  
    echo 'ようこそ、ゲストさん';  
}
```
#### **Cookieの削除**

有効期限を過去の日時に設定することで、ブラウザにCookieを削除させます。
```php
// 'username' Cookieを削除  
setcookie('username', '', time() - 3600);
```
### **Cookieのみを使うケース**

* **次回から自動ログイン**: ログイン情報を長期間保存したい場合。ただし、パスワードそのものではなく、推測困難なトークンを保存します。  
* **サイトの表示設定**: ユーザーが選択した言語設定やテーマ（ライト/ダーク）など。  
* **広告のパーソナライズ**: ユーザーの閲覧履歴を元に、関連性の高い広告を表示する。

### **メリットとデメリット**

* **メリット**:  
  * サーバー側のリソースを消費しない。  
  * 有効期限を長く設定でき、ブラウザを閉じても情報を維持できる。  
* **デメリット**:  
  * **セキュリティリスク**: データがクライアント側にあるため、改ざんや盗聴のリスクがある。重要な情報は保存すべきではない。  
  * **データ容量**: 保存できるデータ量に4KB程度の制限がある。  
  * **ユーザー設定**: ユーザーがブラウザの設定でCookieを無効にしている場合、利用できない。

## **3. セッション変数によるセッション管理**

セッションは、ログイン情報やショッピングカートの中身といった、**重要な情報をサーバー側に保存する仕組み**です。クライアント側には、データを識別するための**セッションID**のみをCookieに保存します。

### **セッションの仕組み**

1. **サーバー**: session_start()が呼び出されると、ユニークな**セッションID**を生成する。  
2. **サーバー → ブラウザ**: 生成したセッションIDをSet-Cookieヘッダを使ってブラウザに送信する。  
3. **ブラウザ**: 受け取ったセッションIDをCookieとして保存する。  
4. **ブラウザ → サーバー**: 次回以降のリクエストで、セッションIDのCookieを自動的に送信する。  
5. **サーバー**: 受け取ったセッションIDを元に、サーバー上に保存されている対応するセッションデータ（例: $_SESSION）を読み込み、利用できるようにする。

### **PHPでの使い方**

#### **セッションの開始**

session_start()関数を、**スクリプトの先頭で必ず**呼び出します。これにより、セッションが開始または再開されます。
```php
<?php  
// 必ずページの先頭で呼び出す  
session_start();
```
#### **セッションへのデータ保存・取得**

スーパーグローバル変数 $_SESSION を使って、連想配列のようにデータを読み書きします。
```php
<?php  
session_start();

// データの保存  
$_SESSION['user_id'] = 123;  
$_SESSION['username'] = 'Jiro';

// データの取得  
if (isset($_SESSION['username'])) {  
    echo 'ログイン中のユーザー: ' . htmlspecialchars($_SESSION['username']);  
}
```
#### **セッションの破棄**

ログアウト処理などで、セッション情報を完全に削除する場合に使用します。
```php
<?php  
session_start();

// セッション変数をすべて空にする  
$_SESSION = array();

// セッションクッキーを削除する  
if (ini_get("session.use_cookies")) {  
    $params = session_get_cookie_params();  
    setcookie(session_name(), '', time() - 42000,  
        $params["path"], $params["domain"],  
        $params["secure"], $params["httponly"]  
    );  
}

// 最終的に、セッションを破壊する  
session_destroy();

echo 'ログアウトしました。';
```
### **セッションに情報を保存するケース**

* **ログイン状態の管理**: ログイン中のユーザーIDや権限レベルなど、セキュリティが重要な情報。  
* **ショッピングカート**: ユーザーがカートに入れた商品情報。  
* **複数ページにまたがるフォーム**: ユーザーが入力した内容を一時的に保持する。  
* **エラーメッセージや通知**: 処理後のリダイレクト先ページで一度だけ表示したいメッセージ（フラッシュメッセージ）。

### **メリットとデメリット**

* **メリット**:  
  * **セキュリティが高い**: 実データはサーバー側にあるため、クライアント側から改ざんされる心配がない。  
  * **データ容量**: 保存できるデータ量に実質的な制限は少ない（サーバーのメモリやディスク容量に依存）。  
* **デメリット**:  
  * **サーバー負荷**: ユーザーごとにセッションファイルを生成・管理するため、アクセスが増えるとサーバーの負荷が高まる。  
  * **有効期限**: ブラウザを閉じるとセッションIDのCookieが破棄され、セッションが終了するのが一般的（設定で変更可能）。

## **4. Cookieとセッションの使い分けまとめ**

| 項目 | Cookie | セッション |
| :---- | :---- | :---- |
| **保存場所** | **クライアント** (ブラウザ) | **サーバー** |
| **セキュリティ** | 低い (改ざん・盗聴リスクあり) | **高い** |
| **データ容量** | 小さい (約4KB) | 大きい (サーバー依存) |
| **有効期限** | 長く設定可能 | ブラウザを閉じると終了が基本 |
| **サーバー負荷** | 軽い | 重い |
| **主な用途** | 利便性向上 (自動ログイン、設定保存) | **認証情報、個人情報、カート情報** |

### **使い分けのポイント**

* **他人に見られても問題ない、利便性を高めるための情報** → **Cookie**  
  * 例: 「次回から自動でログインする」のチェックボックス、言語設定  
* **他人に見られては困る、セキュリティが重要な情報** → **セッション**  
  * 例: ログインしているユーザーのID、ショッピングカートの中身

多くのWebアプリケーションでは、これら2つを組み合わせて利用します。例えば、基本的なセッション管理はセッション変数で行い、利便性を高める「自動ログイン」機能のためにCookieを利用するといった形です。

セッション管理の仕組みを正しく理解し、保存する情報に応じて適切な技術を選択することが、安全で使いやすいWebアプリケーションを開発するための第一歩です。